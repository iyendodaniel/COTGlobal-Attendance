{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Attendance Records</title>
  <link rel="stylesheet" href="{% static 'attendance/css/styles.css' %}">
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">
      <h1>Attendance Records</h1>
      <p class="lead">Admin view — manage and review attendance.</p>
    </div>
    <nav class="nav">
      <a href="{% url 'home' %}">Home</a>
      <a href="{% url 'new_member' %}">New-member</a>
      <a href="{% url 'existing_member' %}">Existing-member</a>
      <a href="{% url 'complete_profile' %}">Complete Profile</a>
      <a href="{% url 'admin' %}" class="active">Admin</a>
      <a href="{% url 'download_page' %}">Download</a>
    </nav>
  </header>
  <form action="{% url 'logout' %}" method="post">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">Logout</button>
  </form>

  <main class="panel">
    <h2 class="h2">Attendance Records</h2>

    <!-- Show errors -->
    {% if error_message %}
      <p style="color:red; font-weight:bold;">{{ error_message }}</p>
    {% endif %}

    <!-- FILTER FORM -->
    <form method="POST">
      {% csrf_token %}
      <div class="controls">
        <div class="grid" style="grid-template-columns: repeat(5, 1fr); gap: 12px;">
          <!-- Year -->
          <div class="field">
            <label>Year</label>
            <select name="year" class="input" style="color:#4960aa;">
              {% for y in years %}
                <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Month -->
          <div class="field">
            <label>Month</label>
            <select name="month" class="input" style="color:#4960aa;">
              <option value="">All months</option>
              {% for m in months %}
                <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>
                  {{ m|stringformat:"02d" }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Role -->
          <div class="field">
            <label>Role</label>
            <select id="filter-role" name="role" class="input" style="color:#4960aa;">
              <option value="">All Roles</option>
              <option value="Child" {% if selected_role == "Child" %}selected{% endif %}>Child</option>
              <option value="Teen" {% if selected_role == "Teen" %}selected{% endif %}>Teen</option>
              <option value="Worker" {% if selected_role == "Worker" %}selected{% endif %}>Worker</option>
            </select>
          </div>

          <!-- Department -->
          <div class="field" id="department_field">
            <label>Department</label>
            <select id="department" name="department" class="input" style="color:#4960aa;">
              <option value="">Select Department</option>
              {% for dept in departments %}
                <option value="{{ dept }}" {% if selected_department == dept %}selected{% endif %}>{{ dept }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Submit -->
          <div class="actions" style="margin-top: 25px;">
            <button type="submit" class="btn">Filter</button>
          </div>
        </div>
      </div>
    </form>

    <!-- TABLE -->
    <div id="grid" class="table-zone" tabindex="0">
      <table id="attendance-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Role</th>
            <th>Department</th>
            {% for sunday in attendance_dates %}
              <th>{{ sunday|date:"d M" }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for member in members %}
          <tr>
            <td>{{ member.name }}</td>
            <td>{{ member.role }}</td>
            <td>{% if member.role == "Worker" %}{{ member.department }}{% else %}---{% endif %}</td>
            {% for mark in member.marks %}
              <td>{% if mark %}✅{% else %}---{% endif %}</td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </main>

  <footer class="footer">
    This page shows the latest marked members per Sunday.
  </footer>
</div>

<!-- SHOW/HIDE DEPARTMENT -->
<script>
  const roleSelect = document.getElementById("filter-role");
  const deptField = document.getElementById("department_field");

  function toggleDepartment() {
    deptField.style.display = roleSelect.value === "Worker" ? "block" : "none";
    if (roleSelect.value !== "Worker") {
      document.getElementById("department").value = "";
    }
  }

  toggleDepartment();
  roleSelect.addEventListener("change", toggleDepartment);
</script>
</body>
</html>
