{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Download â€” Attendance Report</title>
    <link rel="stylesheet" href="{% static 'attendance/css/styles.css' %}" />
  </head>
  <body>
    <div class="container">
      <header class="header">
        <div class="brand">
          <h1>COTGlobal Attendance</h1>
          <p class="lead">Download monthly reports.</p>
        </div>
        <nav class="nav">
        <a href="{% url 'home' %}">Home</a>
        <a href="{% url 'new_member' %}">New-member</a>
        <a href="{% url 'existing_member' %}">Existing-member</a>
        <a href="{% url 'complete_profile' %}">Complete Profile</a>
        <a href="{% url 'admin' %}">Admin</a>
        <a href="{% url 'download_page' %}" class="active">Download</a>
      </nav>
      </header>
      <form action="{% url 'logout' %}" method="post">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Logout</button>
      </form>


      <main class="panel">
        <h2 class="h2">Export CSV</h2>
        <form method="POST" action="{% url 'download' %}" class="controls">
          {% csrf_token %}
          {% if error_message %}
            <p style="color:red; font-weight:bold;">{{ error_message }}</p>
          {% endif %}
          {% if success_message %}
            <p style="color:green; font-weight:bold;">{{ success_message }}</p>
          {% endif %}
          <!-- Month picker -->
          <label for="month">Choose month</label>
          <input id="month" type="month" name="month" class="input input-inline" value="{{ selected_year }}-{{ selected_month|stringformat:'02d' }}" required/>

          <!-- Role filter -->
          <label for="role">Role</label>
          <select id="role" name="role" class="input" style="color: #4960aa;">
              <option value="" {% if selected_role == "" %}selected{% endif %}>All Roles</option>
              <option value="Child" {% if selected_role == "Child" %}selected{% endif %}>Child</option>
              <option value="Teen" {% if selected_role == "Teen" %}selected{% endif %}>Teen</option>
              <option value="Worker" {% if selected_role == "Worker" %}selected{% endif %}>Worker</option>
              <option value="New_Member" {% if selected_role == "New_Member" %}selected{% endif %}>New Member</option>
          </select>

          <!-- Department filter (only for Worker role) -->
          <div id="department_field">
            <label for="department">Department</label>
            <select id="department" name="department" class="input" style="color: #4960aa;">
              <option value="">All departments</option>
              {% for dept in departments %}
                <option value="{{ dept }}">{{ dept }}</option>
              {% endfor %}
            </select>
          </div>

          <button type="submit" class="btn">Download CSV</button>
        </form>
        <p class="small">
          CSV includes one row per member; columns for each Sunday of selected month.
        </p>
      </main>

      <footer class="footer">Open CSV in Excel or Google Sheets.</footer>
    </div>

    <div
      id="site-toast"
      style="
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 24px;
        background: rgba(2, 12, 16, 0.9);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 10px;
        opacity: 0;
        transition: opacity 0.18s;
      "
    ></div>
    <script>
      const roleSelect = document.getElementById("role");
      const deptField = document.getElementById("department_field");

      function toggleDepartment() {
        deptField.style.display = roleSelect.value === "Worker" ? "block" : "none";
        if (roleSelect.value !== "Worker") {
          document.getElementById("department").value = "";
        }
      }

      toggleDepartment();
      roleSelect.addEventListener("change", toggleDepartment);
    </script>
    <script>
      const form = document.querySelector("form.controls");
      const errorEl = document.querySelector("p[style*='color:red']");
      const successEl = document.querySelector("p[style*='color:green']");

      form.addEventListener("submit", () => {
          if (errorEl) errorEl.textContent = "";
          if (successEl) successEl.textContent = "";
      });
    </script>
  </body>
</html>
